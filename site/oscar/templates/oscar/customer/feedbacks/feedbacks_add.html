{% extends 'oscar/customer/baseaccountpage.html' %}

{% load currency_filters %}
{% load purchase_info_tags %}
{% load reviews_tags %}
{% load image_tags %}
{% load display_tags %}
{% load svg_tags %}
{% load compress %}
{% load static %}

{% block title %}
  {{ page_title }} | {{ block.super }}
{% endblock %}
{% block nav_title_center %}
  {{ page_title }}
{% endblock %}

{% block breadcrumbs %}
  <div aria-label="breadcrumb" class="bread d-none d-sm-flex align-center mt-2 mb-3 mx-md-0">
    <button onclick="getBack(); return false" data-id="back-bread-btn" class="pd-0 mr-1">{% icon file_name='interface/arrow-back' size=22 stroke='#111' %}</button>
    <a href="{{ homepage_url }}" data-id="back-bread-btn" class="bread__link router-link-active">Главная</a>
    {% icon file_name='interface/arrow-left' size=24 stroke='#999' %}
    <a href="{% url 'customer:summary' %}" data-id="back-bread-btn" class="bread__link router-link-active">Личный кабинет</a>
    {% icon file_name='interface/arrow-left' size=24 stroke='#999' %}
    <span class="bread__link" aria-current="page">{{ page_title }}</span>
  </div>
{% endblock %}

{% block tabcontent %}
  <div class="profile-personal__block fill-width d-flex flex-column pd-0 pd-sm-4">
    <div class="order__title d-flex justify-start mb-2 align-center">
      <h1>Отзыв на заказ №{{ order.number }}</h1>
    </div>
    {% if order %}
      <div class="fill-width mb-2">
        <div class="cabinet-orders fill-width grow-1">
          <div class="cabinet__promo-wrapper fill-width d-flex flex-column">
            <ul class="orders-list d-flex flex-column fill-width fill-width">
              {% for line in order.lines.all %}
                {% with product=line.product %}
                  <li class="orders-list-item fill-width">
                    <div data-id="cart-item-form" class="cart-items--item">
                      <div class="dish-order d-flex fill-width">
                        <div class="dish-order__picture">
                          <a href="{{ product.get_absolute_url }}" aria-current="page" class="d-block router-link-exact-active router-link-active" data-id="dish-order-image-link">
                            <div class="dish-image fill-width pos-relative">
                              <div class="image">
                                <div class="image__inner" style="padding-bottom: 72.072%;">
                                  {% if product %}
                                    {% with image=product.primary_image %}
                                      {% oscar_thumbnail image.original '250x250' upscale=False as thumb %}
                                      {% if product.is_public %}
                                        <a href="{{ product.get_absolute_url }}"><img class="img-thumbnail" src="{{ thumb.url }}" alt="{{ product.get_name }}" loading="lazy" /></a>
                                      {% else %}
                                        <img class="img-thumbnail" src="{{ thumb.url }}" alt="{{ product.get_name }}" loading="lazy" />
                                      {% endif %}
                                    {% endwith %}
                                  {% else %}
                                    {% with image=line.missing_image %}
                                      {% oscar_thumbnail image.original '100x100' upscale=False as thumb %}
                                      <img src="{{ thumb.url }}" alt="{{ line.name }}" loading="lazy" />
                                    {% endwith %}
                                  {% endif %}
                                </div>
                              </div>
                            </div>
                          </a>
                        </div>
                        <div class="dish-order__content d-flex flex-column fill-width ml-1">
                          <div class="dish-order__title s d-flex align-start fill-width">
                            <div class="dish-order__name-wrapper d-flex fill-width">
                              {% if product and product.is_public %}
                                <a href="{{ product.get_absolute_url }}" aria-current="page" class="dish-order__name router-link-exact-active router-link-active" data-id="dish-order-link">{{ product.get_name }}</a>
                              {% else %}
                                <span>{{ line.name }} (Временно недоступен)</span>
                              {% endif %}
                            </div>
                            <span class="dish-order__name d-flex shrink pd-0">( {{ line.quantity }} шт. )</span>
                          </div>
                          {% if product %}
                            <div class="dish-order__toppings d-flex fill-width">
                              <div class="d-flex flex-wrap" data-id="dish-order-toppings">
                                <span class="d-flex">{{ line.variants }}</span>
                                <span class="d-flex">{{ line.options }}</span>
                                <span class="d-flex">{{ line.additions }}</span>
                              </div>
                            </div>
                            {% if product|is_review_permitted:user %}
                              <a class="page__block text--info d-flex shrink pd-0" href="{% url 'catalogue:reviews-add' product_slug=product.slug product_pk=product.id %}">Оценить</a>
                            {% endif %}
                            <div role="separator" class="spacer"></div>
                            <div class="d-flex fill-width mt-1 pos-relative align-center">
                              <div role="separator" class="spacer"></div>
                              <span class="prices d-flex flex-column align-start">
                                <span class="prices__price no-wrap">
                                  {% purchase_info_for_product request product as session %}
                                  {% include 'oscar/catalogue/partials/product_price.html' %}
                                </span>
                              </span>
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </li>
                {% endwith %}
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
      {% if not order.has_review %}
        {% block order_review %}
          <form method="post" class="prodile-feedback__wrapper">
            {% csrf_token %}
            <div class="d-flex align-center mb-2">
              <div class="controls">
                <div class="profile-feedback_rating-area d-flex flex-row-reverse">
                  {% for value, label in form.score.field.choices %}
                    <input type="radio" name="score" value="{{ value }}" id="id_star_{{ value }}" {% if field.value|default:"" == value %}selected{% endif %}/>
                    {% if value %}
                      <label for="id_star_{{ value }}" title="Оценка «{{ label }}»"></label>
                    {% endif %}
                  {% endfor %}
                </div>
                {% for error in form.score.errors %}
                  <div class="error-block mt-2">
                    <i class="fas fa-exclamation"></i> {{ error }}
                  </div>
                {% endfor %}
              </div>
            </div>
            <div class="input text-area input-textarea d-flex align-center mb-3 mb-sm-3 input__padding input__label-active">
              <div class="input__wrapper">
                <div class="input__control d-flex align-center">
                  {% include 'oscar/partials/render_field.html' with field=form.body %}
                </div>
              </div>
            </div>
            <div class="profile-feedback__submit">
              <button type="submit" class="button button--main">Отправить отзыв</button>
            </div>
          </form>
        {% endblock %}
      {% else %}
        <p>На этот заказ вы уже оставляли отзыв</p>
      {% endif %}
    {% else %}
      <p>Невозвожно оставить отзыв на заказ</p>
    {% endif %}
  </div>
{% endblock %}

{% block extrascripts %}
  {{ block.super }}
  {% compress js inline %}
  <script src="{% static 'js/frontend/profile/profile-links.js' %}" defer></script>
  {% endcompress %}
{% endblock %}
