{% extends 'oscar/dashboard/layout.html' %}
{% load currency_filters %}
{% load image_tags %}
{% load dashboard_tags %}

{% block body_class %}{{ block.super }} orders{% endblock %}

{% block title %}
    Заказ {{ order.number }} | {{ block.super }}
{% endblock %}

{% block breadcrumbs %}
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Главная</a></li>
            <li class="breadcrumb-item"><a href="{% url 'dashboard:order-list' %}">Заказы</a></li>
            <li class="breadcrumb-item active" aria-current="page">№{{ order.number }}</li>
        </ol>
    </nav>
{% endblock %}

{% block navtext %}
    {% if not record.is_online %}
        <i class="fa-solid fa-globe" style="color:var(--primary)"></i>
    {% endif %} 
    {{ order.basket.partner|default:"-" }} | Заказ №{{ order.number }}
{% endblock  %}

{% block dashboard_content %}
    
    {% block customer_information %}
        <table class="table table-bordered table-hover half-wrapper">
            <caption class="table-caption" data-target="#client-body" data-toggle="collapse" aria-controls="client-body" aria-expanded="false">
                <div class="d-flex justify-space-between" >
                    <h3>
                        <i class="fas fa-user"></i> Клиент
                        <span class="badge badge-info ml-2">
                            {{ order.user.date_joined|from_now }} / {{ user_info.order_count|default:"-" }} зак.
                        </span>
                    </h3>
                    <i class="fa-solid fa-chevron-up" style="color: var(--primary);"></i>
                    <i class="fa-solid fa-chevron-down" style="color: var(--primary);"></i>
                </div>
            </caption>
            <tbody class="collapse" id="client-body">
                {% if order.user %}
                    <tr>
                        <th>Имя</th>
                        <td>{{ order.user.get_full_name|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Номер телефона</th>
                        <td class="d-flex justify-content-between align-items-center">
                            <a href="{% url 'dashboard:user-detail' pk=order.user.id %}" class="d-flex flex-column">
                                {{ order.user.name }}
                                {{ order.user.username }}
                            </a>
                            <a class="badge badge-success ml-1" style="padding: .4rem .6rem;" href="tel:{{ order.user.username }}">
                                <i class="fa-solid fa-phone"></i>
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <th>Дата регистрации</th>
                        <td>{{ order.user.date_joined|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Количество заказов</th>
                        <td>{{ user_info.order_count|default:"-" }}</td>
                    </tr>
                    <tr>
                        <th>Сумма заказов</th>
                        <td>{{ user_info.order_amount|default:"-"|currency }}</td>
                    </tr>
                {% else %}
                    <tr><td>Аккаунт пользователя удален</td></tr>
                {% endif %}
            </tbody>
        </table>
    {% endblock customer_information %}

    {% block order_information %}
        <table class="table table-striped table-bordered table-hover half-wrapper" id="order-table">
            <caption class="table-caption" data-target="#orderinfo-body" data-toggle="collapse" aria-controls="orderinfo-body" aria-expanded="false">
                <div class="d-flex justify-space-between" >
                    <h3>
                        <i class="fa-solid fa-circle-info"></i> Информация о заказе
                        {% if order.before_order %}
                            <span class="ml-2 badge {% if order.before_order|in_future %}badge-success{% else %}badge-danger{% endif %}">
                                {% if order.before_order.days %}
                                    {{ order.before_order.days }} дн.
                                {% endif %}
                                {% with hours=order.before_order|hours %}
                                    {% if hours %}
                                        {{ hours }} ч.
                                    {% else %}
                                        {{ order.before_order|minutes }} мин.
                                    {% endif %}
                                {% endwith %}
                            </span>
                        {% endif %}
                    </h3>
                    <i class="fa-solid fa-chevron-up" style="color: var(--primary);"></i>
                    <i class="fa-solid fa-chevron-down" style="color: var(--primary);"></i>
                </div>
            </caption>
            <tbody class="collapse" id="orderinfo-body">
                <tr>
                    <th>Точка продажи</th>
                    <td>
                        {% if order.basket.partner %}
                            <a href="{% url 'dashboard:partner-manage' pk=order.basket.partner.id %}">{{ order.basket.partner|default:"-" }}</a>
                        {% else %}
                            {{ order.basket.partner|default:"-" }}
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Источник</th>
                    <td>
                        {{ order.site|default:"Сайт" }}</td>
                    </td>
                </tr>
                <tr>
                    <th>Сумма заказа</th>
                    <td>{{ order.total|currency:order.currency }}</td>
                </tr>
                <tr>
                    <th>Время заказа</th>
                    <td>{{ order.order_time }}</td>
                </tr>
                <tr>
                    <th>Дата</th>
                    <td>
                        Создан: {{ order.date_placed|date }} {{ order.date_placed|time }}
                        {% if order.date_finish %}
                            <br>
                            Завершен:  {{ order.date_finish|date }} {{ order.date_finish|time }}
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Статус</th>
                    <td>
                        <span class="badge badge-96 {% if order.status == "Завершен" %}badge-success{% elif order.status == "Отменен" %}badge-danger{% elif order.status == "Готовится" %}badge-info{% else %}badge-warning{% endif %}">
                            {{ order.status|default:"N/A" }}
                        </span>
                    </td>
                </tr>
            </tbody>
        </table>
    {% endblock order_information %}

    {% block additional_order_information %}
    {% endblock additional_order_information %}

    <div class="tabbable dashboard">

        {% block nav_tabs %}
            <ul class="nav nav-tabs mb-3 mb-lg-4 p-0" role="tablist">
                <div class="half-wrapper">
                    <div class="nav tabs-button d-flex fill">
                        <div class="tabs-button__active-block" style="width: 140px; left: 0px;"><div class="fill-width fill-height"></div></div>
                        <button role="button" class="tabs-button__button tabs-button__icon {% if active_tab == 'lines' %}active{% endif %}" href="#lines" data-toggle="tab">
                            <i class="fas fa-shopping-cart"></i>
                            <span>
                                Заказ
                            </span>
                        </button>
                        <button role="button" class="tabs-button__button tabs-button__icon {% if active_tab == 'shipping' %}active{% endif %}" href="#shipping" data-toggle="tab">
                            <i class="fa-solid fa-truck-fast"></i>
                            <span>Доставка</span>
                            {% if order.shipping_address %}
                                <i class="spinner-border-sm badge-info rounded-circle ml-1"></i>
                            {% endif %}
                        </button>
                        <button role="button" class="tabs-button__button tabs-button__icon {% if active_tab == 'payment' %}active{% endif %}" href="#payment" data-toggle="tab">
                            <i class="fa-regular fa-credit-card"></i>
                            <span>Оплата</span>
                            {% if order_paid >= order.total %}
                                <i class="spinner-border-sm badge-success rounded-circle ml-1"></i>
                            {% else %}
                                <i class="spinner-border-sm badge-danger rounded-circle ml-1"></i>
                            {% endif %}
                        </button>
                        <button role="button" class="tabs-button__button tabs-button__icon {% if active_tab == 'discounts' %}active{% endif %}" href="#discounts" data-toggle="tab">
                            <i class="fa-solid fa-percent"></i>
                            <span>
                                Скидки
                            </span>
                        </button>
                        <button role="button" class="tabs-button__button tabs-button__icon {% if active_tab == 'notes' %}active{% endif %}" href="#notes" data-toggle="tab">
                            <i class="fa-regular fa-note-sticky"></i>
                            <span>Заметки</span>
                            {% with notes=order.notes.all %}
                                {% if notes %}
                                    <div class="dropdown-item-badge">{{ notes.count }}</div>
                                {% endif %}
                            {% endwith %}
                        </button>
                    </div>
                </div>
            </ul>
        {% endblock nav_tabs %}

        <div class="tab-content">
            <div class="tab-pane fade {% if active_tab == 'lines' %}show active{% endif %}" id="lines" role="tabpanel">
                <div class="table-header d-flex justify-space-between">
                    <h3>
                        <i class="fas fa-shopping-cart"></i>
                        Заказ
                    </h3>
                    <span class="badge {% if order.status == "Завершен" %}badge-success{% elif order.status == "Отменен" %}badge-danger{% elif order.status == "Готовится" %}badge-info{% else %}badge-warning{% endif %}">
                        {{ order.status|default:"N/A" }}
                    </span>
                </div>
                <form id="order_lines_form" method="post" class="form-inline1">
                    {% csrf_token %}
                    
                    {% block order_lines %}
                    <div class="mobile-table">
                        <table class="table table-striped table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th class="checkbox"></th>
                                    <th class="image"></th>
                                    <th class="title">Продукт</th>
                                    <th class="quantity">Кол-во</th>
                                    <th class="title">Доп. продукты</th>
                                    <th class="actions"></th>
                                    <th class="text-right">Цена</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for line in lines %}
                                    <tr>
                                        <td class="checkbox">
                                            <div data-id="selected-line-container">
                                                <input type="checkbox" name="selected_line" value="{{ line.id }}"/>
                                                <div data-id="selected-line-input" class="order-button d-none">
                                                    <button type="button" data-id="order-button-minus" class="order-button-elem">
                                                        <i class="fa-solid fa-minus"></i>
                                                    </button>
                                                    <input type="text" name="selected_line_qty_{{ line.id }}" value="{{ line.quantity }}" min="0" max="{{ line.quantity }}" size="2" class="order-button-value"/>
                                                    <button type="button" {% if line.quantity == 1 %}disabled="disabled"{% endif %} data-id="order-button-plus" class="order-button-elem">
                                                        <i class="fa-solid fa-plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="image">
                                            {% if line.product.primary_image.original.url %}
                                                {% with image=line.product.primary_image %}
                                                    {% oscar_thumbnail image.original "80x80" upscale=False as thumb %}
                                                    <a href="#" data-original="{{ image.original.url }}" class="sub-image">
                                                        <img class="img-dashboard" src="{{ thumb.url }}" alt="{% if image.caption %}{{ image.caption }}{% else %}{{ line.product.get_title }}{% endif %}" loading="lazy">
                                                    </a>
                                                {% endwith %}
                                            {% else %}
                                                —
                                            {% endif %}
                                        </td>
                                        <td class="title">
                                            <div class="d-flex align-items-center">
                                                <span class="spinner-border-sm {% if line.status == "Готовится" %}badge-warning{% elif line.status == "Отменен" %}badge-danger{% else %}badge-success{% endif %} rounded-circle mr-1">&nbsp;</span>
                                                {% if line.product %}
                                                    <a href="{% url 'dashboard:catalogue-product' pk=line.product.id %}">
                                                        {{ line.title }}
                                                        {{ line.variants }}
                                                    </a>
                                                {% else %}
                                                    {{ line.title }}
                                                    {{ line.variants }}
                                                {% endif %}
                                            </div>
                                            <span class="text-muted">
                                                UPC: {{ line.upc|default:"-" }}
                                            </span>
                                        </td>
                                        <td data-label="Количество" class="quantity">{{ line.quantity }}</td>
                                        <td data-label="Доп. продукты" class="title">{{ line.additions|default:"-" }}</td>
                                        <td class="actions">
                                            <a class="btn btn-secondary" href="{% url 'dashboard:order-line-detail' number=order.number line_id=line.id %}">
                                                <i class="fa-solid fa-arrow-up-right-from-square"></i>
                                            </a>
                                        </td>
                                        <td data-label="Цена" class="text-right">{{ line.line_price_before_discounts|currency:order.currency }}</td>
                                        <td class="toggle-row">
                                            <button class="btn btn-secondary" type="button">
                                                <i class="fa-solid fa-chevron-up"></i>
                                                <i class="fa-solid fa-chevron-down"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}
                                <tr>
                                    <td colspan="5"></td>
                                    <th>Скидки</th>
                                    <td class="text-right">{{ order.total_discount|currency:order.currency }}</td>
                                </tr>
                                {% with discounts=order.basket_discounts %}
                                    {% if discounts %}
                                        <tr>
                                            <td colspan="5"></td>
                                            <th>Сумма заказа без скидки</th>
                                            <td class="text-right">{{ order.basket_total_before_discounts|currency:order.currency }}</td>
                                        </tr>
                                        {% for discount in discounts %}
                                            <tr>
                                                <td colspan="5"></td>
                                                <td>
                                                    <span class="badge badge-success">Скидки</span>
                                                    {{ discount.offer_name }}
                                                </td>
                                                <td class="text-right"></td>
                                                <td class="text-right">- {{ discount.amount|currency:order.currency }}</td>
                                            </tr>
                                        {% endfor %}
                                        <tr>
                                            <td colspan="5"></td>
                                            <th>Сумма заказа со скидкой</th>
                                            <th class="text-right">{{ order.basket_total|currency:order.currency }}</th>
                                        </tr>
                                    {% else %}
                                        <tr>
                                            <td colspan="5"></td>
                                            <th>Продукты</th>
                                            <th class="text-right">{{ order.basket_total|currency:order.currency }}</th>
                                        </tr>
                                    {% endif %}
                                {% endwith %}

                                {% if order.has_shipping_discounts %}
                                    <tr>
                                        <td colspan="5"></td>
                                        <td>Доставка без скидки</td>
                                        <td class="text-right">{{ order.shipping_before_discounts|currency:order.currency }}</td>
                                    </tr>
                                    {% for discount in order.shipping_discounts %}
                                        <tr>
                                            <td colspan="5"></td>
                                            <td>
                                                <span class="badge badge-success">Скидка на доставку</span>
                                                {{ discount.offer_name }}
                                            </td>
                                            <td></td>
                                            <td class="text-right">- {{ discount.amount|currency:order.currency }}</td>
                                        </tr>
                                    {% endfor %}
                                    <tr>
                                        <td colspan="5"></td>
                                        <th>Доставка</th>
                                        <th class="text-right">{{ order.shipping|currency:order.currency }}</th>
                                    </tr>
                                {% else %}
                                    <tr>
                                        <td colspan="5"></td>
                                        <th>Доставка</th>
                                        <th class="text-right">{{ order.shipping|currency:order.currency }}</th>
                                    </tr>
                                {% endif %}

                                {% with surcharges=order.surcharges.all %}
                                    {% if surcharges %}
                                        {% for charge in surcharges %}
                                            <tr>
                                                <td colspan="5"></td>
                                                <th>Доплата {{ charge.name }}</th>
                                                <th class="text-right">{{ charge.money|currency:order.currency }}</th>
                                            </tr>
                                        {% endfor %}
                                    {% endif %}
                                {% endwith %}

                                <tr>
                                    <td colspan="5"></td>
                                    <th>Итого</th>
                                    <th class="text-right">{{ order.total|currency:order.currency }}</th>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {% endblock order_lines %}
                    
                    {% block line_actions %}
                    <div class="d-none mb-4" id="actions_lines">
                        <div class="table-header">
                            <div class="d-flex justify-space-between" >
                                <h3>
                                    <i class="fa-solid fa-rotate"></i> Действия
                                </h3>
                            </div>
                        </div>
                        <div class="card card-body bg-light">
                            <h3>С выбранными позициями:</h3>
                            
                            <div class="form-inline mb-sm-2">
                                
                                <div class="form-group">
                                    <div class="form-check">
                                        <input id="line_status_check" class="form-check-input" type="radio" name="line_action" value="change_line_statuses" />
                                        <label for="line_status_check" class="form-check-label">Изменить статус позиций</label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="sr-only" for="new_status_select">Выбрать новый статус</label>
                                    <select id="new_status_select" name="new_status">
                                        <option value=""> -- Выберите новый статус -- </option>
                                        {% for status in line_statuses %}
                                        <option>{{ status }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-inline mb-sm-2">
                                <div class="form-group">
                                    <div class="form-check">
                                        <input id="shipping_event_check" class="form-check-input" type="radio" name="line_action" value="create_shipping_event" />
                                        <label for="shipping_event_check" class="form-check-label">Создать событие доставки</label>
                                    </div>
                                </div>
                                <div class="form-group mr-1">
                                    <label class="sr-only" for="shipping_event_type_select">Выбрать тип события</label>
                                    <select id="shipping_event_type_select" name="shipping_event_type">
                                        <option value=""> -- Выберете тип события -- </option>
                                        {% for event_type in shipping_event_types %}
                                        <option value="{{ event_type.code }}">{{ event_type.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="reference_input">со ссылкой</label>
                                    <input id="reference_input" type="text" name="reference" value="" />
                                </div>
                            </div>

                            <div class="form-inline mb-sm-2">
                                <div class="form-group">
                                    <div class="form-check">
                                        <input id="payment_event_check" class="form-check-input" type="radio" name="line_action" value="create_payment_event" />
                                        <label for="payment_event_check" class="form-check-label">Создать платежное событие</label>
                                    </div>
                                </div>
                                <div class="form-group mr-1">
                                    <label class="sr-only" for="payment_event_type_select">Выберете тип события</label>
                                    <select id="payment_event_type_select" name="payment_event_type">
                                        <option value=""> -- Выберете тип события -- </option>
                                        {% for event_type in payment_event_types %}
                                        <option value="{{ event_type.code }}">{{ event_type.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="amount_input">с суммой</label>
                                    <input id="amount_input" type="text" name="amount" value="" />
                                </div>
                            </div>


                            <div class="flex-nowrap">
                                <button type="submit" class="btn btn-primary">Подтвердить</button>
                            </div>

                        </div>
                    </div>
                    {% endblock line_actions %}
                </form>

                {% block order_status_changes %}
                    <div class="table-header" data-target="#status-body" data-toggle="collapse" aria-controls="status-body" aria-expanded="false">
                        <div class="d-flex justify-space-between" >
                            <h3>
                                <i class="fas fa-exclamation-triangle"></i>  Cтатус заказа
                            </h3>
                            <i class="fa-solid fa-chevron-up" style="color: var(--primary);"></i>
                            <i class="fa-solid fa-chevron-down" style="color: var(--primary);"></i>
                        </div>
                    </div>
                    <div class="collapse" id="status-body">
                        <form method="post" id="order_status_form">
                            {% csrf_token %}
                            {% block order_actions %}
                                <div class="card card-body mb-3">
                                    <h3>Изменить статус заказа:</h3>
                                    {% if order_status_form.has_choices %}
                                        <div class="form-inline fill-width d-flex justify-content-between">
                                            <div class="form-group form-flex-inline">
                                                {% include "oscar/dashboard/partials/form_fields.html" with form=order_status_form %}
                                            </div>
                                            <input type="hidden" value="change_order_status" name="order_action" />
                                            <div class="btn-form d-flex">
                                                <button class="btn btn-primary flex-fill" type="submit" data-loading-text="Изменение...">
                                                    <i class="fas fa-search"></i>
                                                    <span class="ml-2">
                                                        Изменить статус
                                                    </span>
                                                </button>                                                
                                            </div>
                                        </div>
                                    {% else %}
                                        Статус этого заказа нельзя изменить.
                                    {% endif %}
                                </div>
                            {% endblock %}
                        </form>
                        {% with status_changes=order.status_changes.all %}
                            <table class="table table-striped table-bordered table-hover" >
                                <caption>
                                    <h3>
                                        <i class="fa-solid fa-clock-rotate-left"></i>
                                        История изменений статуса
                                    </h3>
                                </caption>
                                {% if status_changes %}
                                    <thead>
                                        <tr>
                                            <th>Старый статус</th>
                                            <th>Новый статус</th>
                                            <th>Дата</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for status_change in status_changes %}
                                            <tr>
                                                <td>{{ status_change.old_status }}</td>
                                                <td>{{ status_change.new_status }}</td>
                                                <td>{{ status_change.date_created }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                {% else %}
                                    <tbody>
                                        <tr>
                                            <td class="empty">Нет изменений статуса</td>
                                        </tr>
                                    </tbody>
                                {% endif %}
                            </table>
                        {% endwith %}
                    </div>
                {% endblock %}
            </div>

            <div class="tab-pane fade {% if active_tab == 'shipping' %}show active{% endif %}" id="shipping" role="tabpanel">
                {% block tab_shipping %}
                    <div class="table-header">
                        <h3>
                            <i class="fa-solid fa-truck-fast"></i>
                            Доставка
                        </h3>
                    </div>
                    <table class="table table-striped table-bordered table-hover">
                        <tbody>
                            <tr>
                                <th>Метод доставки</th>
                                <td>{{ order.shipping_method }}</td>
                            </tr>

                            {% if order.shipping_method == "Доставка" %}
                                <tr>
                                    <th>Стоимость доставки</th>
                                    <td>{{ order.shipping|currency:order.currency }}</td>
                                </tr>
                                <tr>
                                    <th class="d-flex flex-column">
                                        Адрес
                                        <div class="d-flex mt-2">
                                            {% if order.shipping_address %}
                                                <a class="btn btn-third" href="{% url 'dashboard:order-shipping-address' order.number %}">
                                                    <i class="fa-solid fa-pencil"></i>
                                                    <span class="caption-button">
                                                        Изменить
                                                    </span>
                                                </a>
                                                <button class="btn btn-warning ml-1" onclick="openMap('{{ order.shipping_address.line1 }}')">
                                                    <i class="fa-solid fa-location-dot"></i>
                                                    <span class="caption-button">
                                                        На карте
                                                    </span>
                                                </button>
                                                <button class="btn btn-warning ml-1" onclick="createRote('{{ order.shipping_address.line1 }}')">
                                                    <i class="fa-solid fa-location-arrow"></i>
                                                    <span class="caption-button">
                                                        Маршрут
                                                    </span>
                                                </button>
                                            {% endif %}
                                        </div>
                                    </th>
                                    <td>
                                        {% for field in order.shipping_address.active_address_fields_and_labels %}
                                            {{ field.label }}: {{ field.value }}
                                            <br>
                                        {% endfor %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Телефон</th>
                                    <td>{{ order.user.username|default:"-" }}</td>
                                </tr>
                                <tr>
                                    <th>Инструкции курьеру</th>
                                    <td>{{ order.shipping_address.notes|default:"-"|linebreaks }}</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>


                    {% block shipping_events %}
                        {% with events=order.shipping_events.all %}
                        <div class="table-header" data-target="#delivery-body" data-toggle="collapse" aria-controls="delivery-body" aria-expanded="false">
                            <div class="d-flex justify-space-between" >
                                <h3>
                                    <i class="fa-solid fa-truck-ramp-box"></i> События доставки
                                    {% if events.count %}
                                        <span class="dropdown-item-badge ml-1">{{ events.count }}</span>
                                    {% endif %}
                                </h3>
                                <i class="fa-solid fa-chevron-up" style="color: var(--primary);"></i>
                                <i class="fa-solid fa-chevron-down" style="color: var(--primary);"></i>
                            </div>
                        </div>
                            <table class="table table-striped table-bordered table-hover collapse" id="delivery-body">
                                {% if events %}
                                    <thead>
                                        <tr>
                                            <th>Дата</th>
                                            <th>Событие</th>
                                            <th>Позиции</th>
                                            <th>Ссылка</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for event in events %}
                                            {% with line_qtys=event.line_quantities.all %}
                                                <tr>
                                                    <td>{{ event.date_created }}</td>
                                                    <td>{{ event.event_type.name }}</td>
                                                    <td>
                                                        {% for line_qty in event.line_quantities.all %}
                                                            <a href="{% url 'dashboard:order-line-detail' number=order.number line_id=line_qty.line.id %}">
                                                                {{ line_qty.line.title }} (quantity {{ line_qty.quantity }}/{{ line_qty.line.quantity }})
                                                            </a>
                                                        {% endfor %}
                                                    </td>
                                                    <td>{{ event.notes|default:"-" }}</td>
                                                </tr>
                                            {% endwith %}
                                        {% endfor %}
                                    </tbody>
                                {% else %}
                                    <tbody>
                                        <tr>
                                            <td class="empty">Нет событий доставки.</td>
                                        </tr>
                                    </tbody>
                                {% endif %}
                            </table>
                        {% endwith %}
                    {% endblock %}
                    
                {% endblock %}           
            </div>

            <div class="tab-pane fade {% if active_tab == 'payment' %}show active{% endif %}" id="payment" role="tabpanel">
                {% block tab_payment %}

                    {% with sources=order.sources.all %}
                        <div class="table-header">
                            <h3 class="float-left">
                                <i class="fa-solid fa-credit-card"></i>
                                Источники оплаты
                            </h3>
                            <a class="btn btn-secondary float-right caption-fill-width" href="{% url 'dashboard:add-source' number=order.number %}">
                                <i class="fas fa-plus"></i>
                                <span class="caption-button">
                                    Добавить способ оплаты
                                </span>
                            </a>
                        </div>
                        {% if sources %}
                            <div class="mobile-table">
                                <table class="table table-striped table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th class="name">Источник</th>
                                            <th>К оплате</th>
                                            <th>Оплачено</th>
                                            <th>Возвращено</th>
                                            <th class="actions">Обновить</th>
                                            <th>Удалить</th>
                                            <th class="toggle-row"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for source in sources %}
                                            <tr>
                                                <td class="name">
                                                    <div class="d-flex align-items-center">
                                                        <span class="spinner-border-sm {% if source.paid %}badge-success{% else %}badge-danger{% endif %} rounded-circle mr-2">&nbsp;</span>
                                                        {{ source.source_type }} ({{ source.reference|default:"-" }})
                                                    </div>
                                                </td>
                                                <td data-label="К оплате">{{ source.amount_allocated|currency:order.currency }}</td>
                                                <td data-label="Оплачено">{{ source.amount_debited|currency:order.currency }}</td>
                                                <td data-label="Возвращено">{{ source.amount_refunded|currency:order.currency }}</td>
                                                <td class="actions">
                                                    {% if source.payment_id or source.refund_id %}
                                                        <a class="btn btn-info" href="{% url 'dashboard:update-source' number=order.number pk=source.id %}">
                                                            <i class="fa-solid fa-arrows-rotate"></i>
                                                            <span class="caption-button">
                                                                Обновить
                                                            </span>
                                                        </a>
                                                    {% else %}
                                                        <span class="caption-button">
                                                            -
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td data-label="Удалить">
                                                    {% if not source.id in payment_transactions_source_id %}
                                                        <a class="btn btn-danger" href="{% url 'dashboard:delete-source' number=order.number pk=source.id %}">
                                                            <i class="fa-solid fa-trash"></i>
                                                            <span class="caption-button">
                                                                Удалить
                                                            </span>
                                                        </a>
                                                    {% else %}
                                                        Удаление недоступно. 
                                                        Имеются транзакции
                                                    {% endif %}
                                                </td>
                                                <td class="toggle-row">
                                                    <button class="btn btn-secondary" type="button">
                                                        <i class="fa-solid fa-chevron-up"></i>
                                                        <i class="fa-solid fa-chevron-down"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot class="">
                                        <tr>
                                            <td class="table-footer" colspan="8">
                                                {% if order_paid == order.total %}
                                                    <span style="text-success"><strong>Заказ оплачен</strong></span>
                                                {% elif order_paid == 0 %}
                                                    <span style="text-danger"><strong>Заказ не оплачен</strong></span>
                                                {% else %}
                                                    <span style="text-warning"><strong>Оплачено: {{ order_paid|currency:order.currency }}</strong></span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        {% else %}
                            <table class="table table-striped table-bordered table-hover">
                                <tr><td>Источники оплаты для этого заказа не найдены.</td></tr>
                            </table>
                        {% endif %}
                    {% endwith %}

                    {% block payment_transactions %}
                        <div class="table-header">
                            <h3 class="float-left">
                                <i class="fa-solid fa-money-bill-wave"></i>
                                Транзакции
                            </h3>
                            <a class="btn btn-secondary float-right caption-fill-width" href="{% url 'dashboard:add-transaction' number=order.number %}">
                                <i class="fas fa-plus"></i>
                                <span class="caption-button">
                                    Добавить транзакцию
                                </span>
                            </a>
                        </div>
                        {% if payment_transactions %}
                            <div class="mobile-table">
                                <table class="table table-striped table-bordered table-hover">
                                    <thead>
                                        <tr>
                                            <th class="name">Источник</th>
                                            <th class="status">Статус</th>
                                            <th>Тип транзакции</th>
                                            <th>Сумма</th>
                                            <th class="text-table-center">Оплачено</th>
                                            {% comment %} <th class="text-table-center">Чек</th> {% endcomment %}
                                            <th>Дата</th>
                                            <th>Сделать возврат</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for txn in payment_transactions %}
                                            <tr>
                                                <td class="title">{{ txn.source.source_type }} ({{ txn.reference|default:"-" }})</td>
                                                <td class="status">
                                                    <span class="badge badge-96 {% if txn.status == "succeeded" %}badge-success{% elif txn.status == "canceled" %}badge-danger{% else %}badge-warning{% endif %}">
                                                        {% if txn.status == "succeeded" %}
                                                            Успешно
                                                        {% elif txn.status == "canceled" %}
                                                            Отменен
                                                        {% else %}
                                                            Обрабатывется
                                                        {% endif %}
                                                    </span>
                                                </td>
                                                <td data-label="Тип транзакции">
                                                    {% if txn.txn_type == "Payment" %}
                                                        <span class="text-success">
                                                            Оплата
                                                        </span> 
                                                    {% else %}
                                                        <span class="text-danger">
                                                            Возврат
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td data-label="Сумма" class="status">{{ txn.amount|currency:order.currency }}</td>
                                                <td class="is_public" data-label="Оплачено">{{ txn.paid|yesno:"✔️,❌" }}</td>
                                                {% comment %} <td class="is_public" data-label="Чек">{{ txn.receipt|yesno:"✔️,❌" }}</td> {% endcomment %}
                                                <td data-label="Дата">{{ txn.date_created }}</td>
                                                <td data-label="Сумма">
                                                    {% if txn.txn_type == "Payment" and txn.source_refundable and txn.refundable %}
                                                        <a href="{% url 'dashboard:refund-transaction' pk=txn.id %}">Вернуть деньги</a>
                                                    {% elif txn.txn_type == "Refund" %}
                                                        -
                                                    {% else %}
                                                        Возврат недоступен    
                                                    {% endif %}
                                                </td>
                                                <td class="toggle-row">
                                                    <button class="btn btn-secondary" type="button">
                                                        <i class="fa-solid fa-chevron-up"></i>
                                                        <i class="fa-solid fa-chevron-down"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <table class="table table-striped table-bordered table-hover">
                                <tr><td>Транзакции для этого заказа не найдены.</td></tr>
                            </table>
                        {% endif %}
                    {% endblock %}

                    
                    {% block payment_events %}
                        {% with events=order.payment_events.all %}
                            <div class="table-header" data-target="#payment-body" data-toggle="collapse" aria-controls="payment-body" aria-expanded="false">
                                <div class="d-flex justify-space-between" >
                                    <h3>
                                        <i class="fa-solid fa-cash-register"></i> Платежные события
                                        {% if events.count %}
                                            <span class="dropdown-item-badge ml-1">{{ events.count }}</span>
                                        {% endif %}
                                    </h3>
                                    <i class="fa-solid fa-chevron-up" style="color: var(--primary);"></i>
                                    <i class="fa-solid fa-chevron-down" style="color: var(--primary);"></i>
                                </div>
                            </div>
                            <div class="mobile-table">
                                <table class="table table-striped table-bordered table-hover collapse" id="payment-body">
                                    {% if events %}
                                        <thead>
                                            <tr>
                                                <th>Событие</th>
                                                <th>Сумма</th>
                                                <th>Позиции</th>
                                                <th>Дата</th>
                                                <th>Код транзакции</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for event in events %}
                                                {% with line_qtys=event.line_quantities.all %}
                                                    <tr>
                                                        <td class="name">
                                                            {% if event.event_type.name == "Оплата не удалась" %}
                                                                <span class="text-danger">
                                                            {% elif event.event_type.name == "Успешная оплата" %}
                                                                <span class="text-success">
                                                            {% else %}
                                                                <span>
                                                            {% endif %}
                                                            {{ event.event_type.name }}
                                                            </span>
                                                        </td>
                                                        <td data-label="Сумма">{{ event.amount|currency:order.currency }}</td>
                                                        <td data-label="Позиции">
                                                            {% for line_qty in event.line_quantities.all %}
                                                                {{ line_qty.line.title }} ({{ line_qty.quantity }} шт.)
                                                                </br>
                                                            {% endfor %}
                                                        </td>
                                                        <td data-label="Дата">{{ event.date_created }}</td>
                                                        <td data-label="Код транзакции">{{ event.reference|default:"-" }}</td>
                                                        <td class="toggle-row">
                                                            <button class="btn btn-secondary" type="button">
                                                                <i class="fa-solid fa-chevron-up"></i>
                                                                <i class="fa-solid fa-chevron-down"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                {% endwith %}
                                            {% endfor %}
                                        </tbody>
                                    {% else %}
                                        <tbody>
                                            <tr><td class="empty">Нет платежных событий.</td></tr>
                                        </tbody>
                                    {% endif %}
                                </table>
                            </div>
                        {% endwith %}
                    {% endblock %}


                {% endblock %}
            </div>

            <div class="tab-pane fade {% if active_tab == 'discounts' %}show active{% endif %}" id="discounts" role="tabpanel">
                {% block tab_discounts %}

                    {% with discounts=order.discounts.all %}
                        <div class="table-header">
                            <h3>
                                <i class="fa-solid fa-percent"></i>
                                Скидки
                            </h3>
                        </div>
                        {% if discounts %}
                            <table class="table table-striped table-bordered table-hover">
                                <thead>
                                    <tr>
                                        <th>Тип</th>
                                        <th>Промокод</th>
                                        <th>Скидка</th>
                                        <th>Frequency</th>
                                        <th>Сообщение</th>
                                        <th>Сумма</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for discount in discounts %}
                                        <tr>
                                            <td>{{ discount.get_category_display }}</td>
                                            <td>
                                                {{ discount.voucher.code|default:"-" }}
                                            </td>
                                            <td>
                                                {% if discount.offer %}
                                                    <a href="{% url 'dashboard:offer-detail' pk=discount.offer.id %}">{{ discount.offer.name }}</a>
                                                {% else %}
                                                    {{ discount.offer_name }}
                                                {% endif %}
                                            </td>
                                            <td>{{ discount.frequency }}</td>
                                            <td>{{ discount.message|default:"-" }}</td>
                                            <td>{{ discount.amount|currency:order.currency }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        {% else %}
                            <table class="table table-striped table-bordered table-hover">
                                <tr><td>К этому заказу скидки не применялись.</td></tr>
                            </table>
                        {% endif %}
                    {% endwith %}

                {% endblock %}
            </div>

            <div class="tab-pane fade {% if active_tab == 'notes' %}show active{% endif %}" id="notes" role="tabpanel">
                {% block tab_notes %}
                    <div class="table-header">
                        <h3>
                            <i class="fa-solid fa-note-sticky"></i>
                            Заметки
                        </h3>
                    </div>
                    {% with notes=order.notes.all %}
                    <div class="mobile-table">
                        <table class="table table-striped table-bordered table-hover">
                            {% if notes %}
                                <thead>
                                    <tr>
                                        <th class="title">Сообщение</th>
                                        <th>Тип</th>
                                        <th>Пользователь</th>
                                        <th>Дата</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                {% for note in notes %}
                                    <tbody>
                                        <tr>
                                            <td class="title"><strong>{{ note.message|linebreaks }}</strong></td>
                                            <td data-label="Тип">{{ note.note_type|default:"-" }}</td>
                                            <td data-label="Пользователь">{{ note.user|default:"-" }}</td>
                                            <td data-label="Дата">{{ note.date_created }}</td>
                                            <td class="actions">
                                                {% if note.is_editable %}
                                                    <div class="d-flex justify-content-center">
                                                        <a href="{% url 'dashboard:order-detail-note' number=order.number note_id=note.id %}#notes" class="btn btn-info mr-2">
                                                            <i class="fa-solid fa-pencil"></i>
                                                            <span class="caption-button">
                                                                Изменить
                                                            </span>
                                                        </a>
                                                        <form method="post" class="float-left m-0">
                                                            {% csrf_token %}
                                                            <input type="hidden" name="order_action" value="delete_note" />
                                                            <input type="hidden" name="note_id" value="{{ note.id }}" />
                                                            <button type="submit"class="btn btn-danger">
                                                                <i class="fa-solid fa-trash"></i>
                                                                <span class="caption-button">
                                                                    Удалить
                                                                </span>
                                                            </button>
                                                        </form>
                                                    </div>
                                                {% endif %}
                                            </td>
                                            <td class="toggle-row">
                                                <button class="btn btn-secondary" type="button">
                                                    <i class="fa-solid fa-chevron-up"></i>
                                                    <i class="fa-solid fa-chevron-down"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    <tbody>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td class="empty">Нет доступных заметок.</td>
                                </tr>
                            {% endif %}
                        </table>
                    </div>
                    {% endwith %}

                    <div class="table-header">
                        <h3>
                            <i class="fas fa-plus"></i>
                            Создать заметку
                        </h3>
                    </div>
                    <div class="card card-body bg-light">
                        <form id="order_note_form" action=".?note={{ note_id }}" method="post" class="form-stacked fill-width">
                            {% csrf_token %}
                            <input type="hidden" value="save_note" name="order_action" />
                            {% include "oscar/dashboard/partials/form_fields.html" with form=note_form %}
                            <p class="mt-2 text-muted">
                                Заметки можно редактировать только в течение 5 минут после сохранения.
                            </p>
                            <div class="form-actions mt-2 d-flex justify-content-end">
                                <button type="submit" class="btn btn-primary">
                                    Сохранить заметку
                                </button>
                            </div>
                        </form>
                    </div>
                {% endblock %}
            </div>

            {% block extra_tabs %}{% endblock %}
        </div>
    </div>

    
    <div class="modal fade" id="product-image-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title"></h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Закрыть"><span aria-hidden="true">&times;</span></button>
                </div>
                <div class="modal-body text-center">
                    <img class="img-fluid mx-auto" loading="lazy">
                </div>
            </div>
        </div>
    </div>
    

{% endblock dashboard_content %}

{% block onbodyload %}
    {{ block.super }}
    oscar.dashboard.thumbnails.init();
    oscar.dashboard.orders.initTabs();
    oscar.dashboard.orders.initTable();
{% endblock %}
