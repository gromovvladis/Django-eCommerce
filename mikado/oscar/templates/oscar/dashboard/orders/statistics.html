{% extends 'oscar/dashboard/layout.html' %}
{% load currency_filters %}
{% load django_tables2 %}
{% load widget_tweaks %}
{% load dashboard_tags %}
{% load svg_tags %}
{% load compress %}
{% load static %}

{% block body_class %}{{ block.super }} orders{% endblock %}

{% block title %}
    Статистика заказов | {{ block.super }}
{% endblock %}

{% block breadcrumbs %}
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Главная</a></li>
            <li class="breadcrumb-item"><a href="{% url 'dashboard:order-list' %}">Заказы</a></li>
            <li class="breadcrumb-item active" aria-current="page">Статистика</li>
        </ol>
    </nav>
{% endblock %}

{% block navtext %}{{ title }}{% endblock %}

{% block dashboard_content %}
    <div class="table-wrapper mb-4">
        <div class="table-header d-flex justify-space-between" data-target="#search-body" 
        data-toggle="collapse" aria-controls="search-body" aria-expanded="false">
            <h3><i class="fas fa-filter"></i> Фильтр</h3>
            <i class="fa-solid fa-chevron-up" style="color: var(--primary);"></i>
            <i class="fa-solid fa-chevron-down" style="color: var(--primary);"></i>
        </div>
        <div class="card card-body bg-light {% if form.is_valid %}collapse{% endif %}" id="search-body">
            <form method="get" action="{% url 'dashboard:order-stats' %}" class="form-inline fill-width d-flex justify-content-between align-items-end">
                <div>
                    {% for field in form %}
                        {% if "date_range" in field.id_for_label %}
                            {% if field.is_hidden %}
                                {% render_field field class+='form-control' %}
                            {% else %}
                                <div class="form-group form-flex-inline date-form">
                                    {{ field.label_tag }}
                                    {% render_field field class+='form-control' %}
                                    {% for error in field.errors %}
                                        <ul class="error-block">
                                            <li>{{ error }}</li>
                                        </ul>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
                <div class="btn-form d-flex">
                    <button class="btn btn-primary flex-fill" type="submit" data-loading-text="Поиск...">
                        <i class="fas fa-search"></i>
                        <span class="ml-2">
                            Поиск
                        </span>
                    </button>
                    <a data-toggle="modal" class="btn btn-third ml-2" data-target="#SearchModal" href="#">
                        <i class="fa-solid fa-bars"></i>
                    </a>
                    {% if request.GET %}
                        <a href="{% url 'dashboard:order-stats' %}" class="btn btn-danger ml-2">
                            <i class="fa-solid fa-trash"></i>
                            <span class="caption-button">
                                Сбросить
                            </span>
                        </a>
                    {% endif %}
                </div>   
            </form>
            {% include "oscar/dashboard/partials/advanced_search_modal.html" with form=form style='horizontal' %}
            {% if search_filters %}
                <div class="search-filter-list mt-4">
                    <label class="mr-2">Фильтры:</label>
                    {% for filter, param in search_filters %}
                        <span class="badge badge-filter mb-2 mr-1">{{ filter }}
                            <a class="delete-filter text-danger ml-1" href="{% delete_filter request param %}">
                                <i class="fa-solid fa-xmark"></i>
                            </a>    
                        </span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>

        
    <div class="page-header d-flex justify-content-between mb-2">
        <h1>Заказы</h1>
    </div>
    <ul class="nav nav-tabs mb-3 mb-lg-4 p-0" role="tablist">
        {% block nav_tabs %}
            <div class="tabs-button-wrapper">
                <div class="nav tabs-button d-flex fill">
                    <div class="tabs-button__active-block" style="width: calc(100% / 4); left: 0px;"><div class="fill-width fill-height"></div></div>
                    <button role="button" class="tabs-button__button tabs-button__icon {% if active_tab == 'day' %}active{% endif %}" href="#statistic_day" data-toggle="tab">
                        День
                    </button>
                    <button role="button" class="tabs-button__button tabs-button__icon {% if active_tab == 'week' %}active{% endif %}" href="#statistic_week" data-toggle="tab">
                        Неделя
                    </button>
                    <button role="button" class="tabs-button__button tabs-button__icon {% if active_tab == 'month' %}active{% endif %}" href="#statistic_month" data-toggle="tab">
                        Месяц
                    </button>
                    <button role="button" class="tabs-button__button tabs-button__icon {% if active_tab == 'year' %}active{% endif %}" href="#statistic_year" data-toggle="tab">
                        Год
                    </button>
                </div>
            </div>
        {% endblock nav_tabs %}
    </ul>


    <div class="tab-content">
        <div class="tab-pane fade {% if active_tab == 'day' %}show active{% endif %}" id="statistic_day" role="tabpanel">
            
            
            <div class="content-block rounded">
                <div class="d-flex justify-content-center fill-width my-2"><h2>Заказы |<span class="text-primary"> {{ start_date_days|date:"d.m.y" }} - {{ end_time|date:"d.m.y" }}</span></h2></div>
                {% if report_exist_days %}
                    <div class="chart-container my-2">
                        <canvas class="canvas-graph" id="dayGraphChart"></canvas>
                    </div>
                    <div class="pagination">
                        <button id="prevPage">Previous</button>
                        <span id="pageInfo">Page 1</span>
                        <button id="nextPage">Next</button>
                    </div>
                {% else %}
                    <div class="empty-report">
                        <span>
                            Нет созданных заказов
                        </span>
                    </div>
                {% endif %}
            </div>

            <div class="row">
                <div class="col-md-4">
                    <table class="table table-striped table-bordered table-hover table-text-right">
                        <caption><i class="fas fa-shopping-cart"></i> Заказы |<span class="text-primary"> {{ start_date|date:"d.m.y" }} - {{ end_time|date:"d.m.y" }}</span></caption>
                        <tr>
                            <th class="col-md-10">Всего заказов</th>
                            <td class="col-md-2" >{{ orders_days }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Всего позиций</th>
                            <td class="col-md-2" >{{ alerts_days }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Новых пользователей</th>
                            <td class="col-md-2" >{{ users_days }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Новых клиентов</th>
                            <td class="col-md-2" >{{ customers_days }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Всего создано корзин</th>
                            <td class="col-md-2" >{{ baskets_days }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Общий доход</th>
                            <td class="col-md-2" >{{ revenue_days|currency }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Средняя стоимость заказа</th>
                            <td class="col-md-2" >{{ average_costs_days|currency }}</td>
                        </tr>
                    </table>
                </div>
            
                <div class="col-md-4">
                    <table class="table table-striped table-bordered table-hover table-text-right">
                        <caption><i class="fas fa-users"></i> Клиенты
                            <a href="{% url 'dashboard:customers' %}" class="btn btn-secondary float-right caption-fill-width">
                                <i class="fas fa-gears"></i> 
                                <span class="caption-button"> Управление</span>
                            </a>
                        </caption>
                        <tr>
                            <th class="col-md-10">Всего пользователей</th>
                            <td class="col-md-2" >{{ users_days }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Всего клиентов</th>
                            <td class="col-md-2" >{{ customers_days }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Клиенты с 2 и более заказами</th>
                            <td class="col-md-2" >{{ customers_2orders_days }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Клиенты с 5 и более заказами</th>
                            <td class="col-md-2" >{{ customers_5orders_days }}</td>
                        </tr>
                    </table>
                </div>
        
                {% if order_status_breakdown %}
                    <div class="col-md-4">
                        <table class="table table-striped table-bordered table-hover table-text-right">
                            <caption><i class="fas fa-shopping-cart"></i> Статусы заказов</caption>
                            {% comment %} <tr>
                                <th>Статус</th>
                                <th>Количество</th>
                            </tr> {% endcomment %}
                            {% for dict in order_status_breakdown %}
                                <tr>
                                    <th><a href="{% url 'dashboard:order-list' %}{% querystring 'status'=dict.status %}">{{ dict.status }}</a></th>
                                    <td>{{ dict.freq }}</td>
                                </tr>
                            {% endfor %}
                        </table>
                    </div>
                {% endif %}

                <div class="col-md-4">
                    <table class="table table-striped table-bordered table-hover table-text-right">
                        <caption>
                            <i class="fas fa-shopping-cart"></i> Топ продаж</span>
                            <a href="{% url 'dashboard:catalogue-product-list' %}" class="btn btn-secondary float-right caption-fill-width">
                                <i class="fas fa-gears"></i> 
                                <span class="caption-button"> Управление</span>
                            </a>
                        </caption>
                        <thead>
                            <tr>
                                <th class="col-md-9">Продукт</th>
                                <td class="col-md-3">Кол-во</td>
                                <td class="col-md-3">Сумма</td>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prd in top_products_days %}
                                <tr>
                                    <th class="col-md-9">
                                        <a href="{% url 'dashboard:catalogue-product' pk=prd.product %}">
                                            {{ prd.title }}
                                        </a>
                                    </th>
                                    <td class="col-md-3" >{{ prd.total_quantity }}</td>
                                    <td class="col-md-3" >{{ prd.total_sum|currency }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="col-md-8 content-block rounded tab-content d-flex flex-column align-items-center">

                    <div class="tabs-button-wrapper">
                        <div class="nav tabs-button d-flex fill" role="tablist">
                            <div class="tabs-button__active-block" style="width: calc(100% / 2); left: 0px;"><div class="fill-width fill-height"></div></div>
                            <button role="button" class="tabs-button__button tabs-button__icon" href="#top_product_price_day" data-toggle="tab">
                                По стоимости
                            </button>
                            <button role="button" class="tabs-button__button tabs-button__icon" href="#top_product_count_day" data-toggle="tab">
                                По количеству
                            </button>
                        </div>
                    </div>

                    <div class="tab-pane fade show active chart-container" id="top_product_price_day" role="tabpanel">
                        <div class="d-flex justify-content-center mt-4">
                            <canvas class="canvas-graph canvas-graph--doughnut" id="dayPriceChart"></canvas>
                        </div>
                    </div>

                    <div class="tab-pane fade chart-container" id="top_product_count_day" role="tabpanel">
                        <div class="d-flex justify-content-center mt-4">
                            <canvas class="canvas-graph canvas-graph--doughnut" id="dayCountChart"></canvas>
                        </div>
                    </div>

                </div>
                
            </div>
        </div>

        <div class="tab-pane fade {% if active_tab == 'week' %}show active{% endif %}" id="statistic_week" role="tabpanel">
            <div class="row">
                <div class="col-md-4">
                    <table class="table table-striped table-bordered table-hover table-text-right">
                        <caption><i class="fas fa-shopping-cart"></i> Заказы |<span class="text-primary"> 24 часа</span></caption>
                        <tr>
                            <th class="col-md-10">Всего заказов</th>
                            <td class="col-md-2" >{{ total_orders_last_day }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Всего позиций</th>
                            <td class="col-md-2" >{{ total_lines_last_day }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Новых пользователей</th>
                            <td class="col-md-2" >{{ total_users_last_day }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Новых клиентов</th>
                            <td class="col-md-2" >{{ total_customers_last_day }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Всего создано корзин</th>
                            <td class="col-md-2" >{{ total_open_baskets_last_day }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Общий доход</th>
                            <td class="col-md-2" >{{ total_revenue_last_day|currency }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Средняя стоимость заказа</th>
                            <td class="col-md-2" >{{ average_order_costs_day|currency }}</td>
                        </tr>
                    </table>
                </div>
            
                <div class="col-md-4">
                    <table class="table table-striped table-bordered table-hover table-text-right">
                        <caption><i class="fas fa-users"></i> Клиенты
                            <a href="{% url 'dashboard:customers' %}" class="btn btn-secondary float-right caption-fill-width">
                                <i class="fas fa-gears"></i> 
                                <span class="caption-button"> Управление</span>
                            </a>
                        </caption>
                        <tr>
                            <th class="col-md-10">Всего пользователей</th>
                            <td class="col-md-2" >{{ total_users }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Всего клиентов</th>
                            <td class="col-md-2" >{{ total_customers }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Клиенты с 2 и более заказами</th>
                            <td class="col-md-2" >{{ total_customers_2orders }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Клиенты с 5 и более заказами</th>
                            <td class="col-md-2" >{{ total_customers_5orders }}</td>
                        </tr>
                    </table>
                </div>
        
                {% if order_status_breakdown %}
                    <div class="col-md-4">
                        <table class="table table-striped table-bordered table-hover">
                            <caption><i class="fas fa-shopping-cart"></i> Статусы заказов</caption>
                            <tr>
                                <th>Статус</th>
                                <th>Количество</th>
                            </tr>
                            {% for dict in order_status_breakdown %}
                                <tr>
                                    <td><a href="{% url 'dashboard:order-list' %}{% querystring 'status'=dict.status %}">{{ dict.status }}</a></td>
                                    <td>{{ dict.freq }}</td>
                                </tr>
                            {% endfor %}
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="tab-pane fade {% if active_tab == 'month' %}show active{% endif %}" id="statistic_month" role="tabpanel">
            <div class="row">
                <div class="col-md-4">
                    <table class="table table-striped table-bordered table-hover table-text-right">
                        <caption><i class="fas fa-shopping-cart"></i> Заказы |<span class="text-primary"> 24 часа</span></caption>
                        <tr>
                            <th class="col-md-10">Всего заказов</th>
                            <td class="col-md-2" >{{ total_orders_last_day }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Всего позиций</th>
                            <td class="col-md-2" >{{ total_lines_last_day }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Новых пользователей</th>
                            <td class="col-md-2" >{{ total_users_last_day }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Новых клиентов</th>
                            <td class="col-md-2" >{{ total_customers_last_day }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Всего создано корзин</th>
                            <td class="col-md-2" >{{ total_open_baskets_last_day }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Общий доход</th>
                            <td class="col-md-2" >{{ total_revenue_last_day|currency }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Средняя стоимость заказа</th>
                            <td class="col-md-2" >{{ average_order_costs_day|currency }}</td>
                        </tr>
                    </table>
                </div>
            
                <div class="col-md-4">
                    <table class="table table-striped table-bordered table-hover table-text-right">
                        <caption><i class="fas fa-users"></i> Клиенты
                            <a href="{% url 'dashboard:customers' %}" class="btn btn-secondary float-right caption-fill-width">
                                <i class="fas fa-gears"></i> 
                                <span class="caption-button"> Управление</span>
                            </a>
                        </caption>
                        <tr>
                            <th class="col-md-10">Всего пользователей</th>
                            <td class="col-md-2" >{{ total_users }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Всего клиентов</th>
                            <td class="col-md-2" >{{ total_customers }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Клиенты с 2 и более заказами</th>
                            <td class="col-md-2" >{{ total_customers_2orders }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Клиенты с 5 и более заказами</th>
                            <td class="col-md-2" >{{ total_customers_5orders }}</td>
                        </tr>
                    </table>
                </div>
        
                {% if order_status_breakdown %}
                    <div class="col-md-4">
                        <table class="table table-striped table-bordered table-hover">
                            <caption><i class="fas fa-shopping-cart"></i> Статусы заказов</caption>
                            <tr>
                                <th>Статус</th>
                                <th>Количество</th>
                            </tr>
                            {% for dict in order_status_breakdown %}
                                <tr>
                                    <td><a href="{% url 'dashboard:order-list' %}{% querystring 'status'=dict.status %}">{{ dict.status }}</a></td>
                                    <td>{{ dict.freq }}</td>
                                </tr>
                            {% endfor %}
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
        <div class="tab-pane fade {% if active_tab == 'year' %}show active{% endif %}" id="statistic_year" role="tabpanel">
            <div class="row">
                <div class="col-md-4">
                    <table class="table table-striped table-bordered table-hover table-text-right">
                        <caption><i class="fas fa-shopping-cart"></i> Заказы |<span class="text-primary"> 24 часа</span></caption>
                        <tr>
                            <th class="col-md-10">Всего заказов</th>
                            <td class="col-md-2" >{{ total_orders_last_day }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Всего позиций</th>
                            <td class="col-md-2" >{{ total_lines_last_day }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Новых пользователей</th>
                            <td class="col-md-2" >{{ total_users_last_day }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Новых клиентов</th>
                            <td class="col-md-2" >{{ total_customers_last_day }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Всего создано корзин</th>
                            <td class="col-md-2" >{{ total_open_baskets_last_day }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Общий доход</th>
                            <td class="col-md-2" >{{ total_revenue_last_day|currency }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Средняя стоимость заказа</th>
                            <td class="col-md-2" >{{ average_order_costs_day|currency }}</td>
                        </tr>
                    </table>
                </div>
            
                <div class="col-md-4">
                    <table class="table table-striped table-bordered table-hover table-text-right">
                        <caption><i class="fas fa-users"></i> Клиенты
                            <a href="{% url 'dashboard:customers' %}" class="btn btn-secondary float-right caption-fill-width">
                                <i class="fas fa-gears"></i> 
                                <span class="caption-button"> Управление</span>
                            </a>
                        </caption>
                        <tr>
                            <th class="col-md-10">Всего пользователей</th>
                            <td class="col-md-2" >{{ total_users }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Всего клиентов</th>
                            <td class="col-md-2" >{{ total_customers }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Клиенты с 2 и более заказами</th>
                            <td class="col-md-2" >{{ total_customers_2orders }}</td>
                        </tr>
                        <tr>
                            <th class="col-md-10">Клиенты с 5 и более заказами</th>
                            <td class="col-md-2" >{{ total_customers_5orders }}</td>
                        </tr>
                    </table>
                </div>
        
                {% if order_status_breakdown %}
                    <div class="col-md-4">
                        <table class="table table-striped table-bordered table-hover">
                            <caption><i class="fas fa-shopping-cart"></i> Статусы заказов</caption>
                            <tr>
                                <th>Статус</th>
                                <th>Количество</th>
                            </tr>
                            {% for dict in order_status_breakdown %}
                                <tr>
                                    <td><a href="{% url 'dashboard:order-list' %}{% querystring 'status'=dict.status %}">{{ dict.status }}</a></td>
                                    <td>{{ dict.freq }}</td>
                                </tr>
                            {% endfor %}
                        </table>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>


    {% comment %} <table class="table table-striped table-bordered table-hover">
        <caption><i class="fas fa-shopping-cart"></i> Краткая статистика</caption>
        <tr>
            <th>Всего заказов</th>
            <td>{{ total_orders }}</td>
        </tr>
        <tr>
            <th>Всего позиций</th>
            <td>{{ total_lines }}</td>
        </tr>
        <tr>
            <th>Общий доход</th>
            <td>{{ total_revenue|currency }}</td>
        </tr>
    </table> {% endcomment %}

{% endblock dashboard_content %}

{% block templatescripts %}
    var products_titles_days = {{ top_products_titles_days|safe }}
    var products_sum_days = {{ top_products_sum_days|safe }}
    var products_quantity_days = {{ top_products_quantity_days|safe }}

    var orders_data_days = {{ report_data_days|safe }}
    
{% endblock %}

{% block extrascripts %}
    {% comment %} {% compress js %} {% endcomment %}
        <script src="{% static "js/dashboard/statistic-orders.js" %}" async></script>
    {% comment %} {% endcompress %} {% endcomment %}
{% endblock %}